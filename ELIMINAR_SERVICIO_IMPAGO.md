# üóëÔ∏è Funcionalidad: Eliminar Servicio Impago

## üìã Descripci√≥n

Funcionalidad para eliminar servicios en estado **impago** con control de permisos. Solo usuarios con rol **Admin (role_id = 2)** o **Super (role_id = 3)** pueden eliminar servicios.

---

## üîí Validaciones Implementadas

### 1. ‚úÖ Validaci√≥n de Permisos de Usuario
```php
if (!in_array($usuario->role_id, [2, 3])) {
    return redirect()->back()
        ->withErrors(['No tienes permisos para eliminar servicios...']);
}
```
- Solo **Admin (2)** o **Super (3)** pueden eliminar
- Usuarios normales no ven el bot√≥n de eliminar

### 2. ‚úÖ Validaci√≥n de Existencia del Servicio
```php
if (!$servicioPagar) {
    return redirect()->back()
        ->withErrors(['El servicio no existe.']);
}
```

### 3. ‚úÖ Validaci√≥n de Empresa
```php
if ($servicio->empresa_id != $usuario->empresa_id) {
    return redirect()->back()
        ->withErrors(['No puedes eliminar servicios de otra empresa.']);
}
```
- Solo se pueden eliminar servicios de la propia empresa

### 4. ‚úÖ Validaci√≥n de Estado IMPAGO
```php
if ($servicioPagar->estado !== 'impago') {
    return redirect()->back()
        ->withErrors(['Solo se pueden eliminar servicios en estado IMPAGO...']);
}
```
- **Solo servicios impagos** pueden ser eliminados
- Servicios pagados **NO** se pueden eliminar

---

## üìÅ Archivos Modificados

### 1. Controller: `ServicioPagarController.php`

**M√©todo agregado:** `EliminarServicioImpago($idServicioPagar)`

**Caracter√≠sticas:**
- ‚úÖ 4 validaciones de seguridad
- ‚úÖ Logs detallados de la eliminaci√≥n
- ‚úÖ Manejo completo de errores
- ‚úÖ Mensajes de error descriptivos

### 2. Ruta: `routes/web.php`

```php
Route::delete('EliminarServicioImpago/{idServicioPagar}', 
    [ServicioPagarController::class, 'EliminarServicioImpago'])
    ->name('EliminarServicioImpago');
```

**Caracter√≠sticas:**
- M√©todo HTTP: **DELETE**
- Protegida por autenticaci√≥n
- Par√°metro: `idServicioPagar`

### 3. Vista: `ServiciosImpagos.blade.php`

**Bot√≥n agregado:**
- Solo visible para Admin (2) y Super (3)
- Confirmaci√≥n antes de eliminar
- Muestra informaci√≥n del servicio en el alert
- Color rojo para indicar acci√≥n destructiva

---

## üéØ Roles y Permisos

| Role ID | Nombre | Puede Eliminar Servicios |
|---------|--------|--------------------------|
| 1 | Usuario | ‚ùå No |
| 2 | Admin | ‚úÖ S√≠ |
| 3 | Super | ‚úÖ S√≠ |

---

## üí¨ Flujo de Eliminaci√≥n

```
Usuario Admin/Super hace clic en "Eliminar"
              ‚Üì
    Aparece confirmaci√≥n JavaScript
    (Muestra datos del servicio)
              ‚Üì
         Usuario confirma
              ‚Üì
    Se env√≠a formulario con m√©todo DELETE
              ‚Üì
    Controller: EliminarServicioImpago()
              ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ Validaci√≥n 1: Permisos Usuario  ‚îÇ
    ‚îÇ Validaci√≥n 2: Servicio Existe   ‚îÇ
    ‚îÇ Validaci√≥n 3: Empresa Correcta  ‚îÇ
    ‚îÇ Validaci√≥n 4: Estado = impago   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚Üì
         Todas OK?
              ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚ñº                    ‚ñº
  S√≠                    No
    ‚îÇ                    ‚îÇ
    ‚ñº                    ‚ñº
Elimina              Retorna
Servicio             con Error
    ‚îÇ
    ‚ñº
Registra Log
    ‚îÇ
    ‚ñº
Redirecciona con
mensaje de √©xito
```

---

## üîç Mensaje de Confirmaci√≥n

Cuando el usuario hace clic en "Eliminar", ve:

```
¬øEst√° seguro que desea eliminar este servicio impago?

Cliente: Juan P√©rez
Servicio: Internet 100MB
Total: $5000.00

Esta acci√≥n no se puede deshacer.
```

**Botones:**
- ‚úÖ Aceptar ‚Üí Elimina el servicio
- ‚ùå Cancelar ‚Üí No hace nada

---

## üìä Logs Generados

### ‚úÖ Log de Eliminaci√≥n Exitosa

```log
[2025-10-30 15:30:00] local.INFO: Servicio impago eliminado
{
  "usuario_id": 1,
  "usuario_nombre": "Admin User",
  "role_id": 2,
  "servicio_pagar_id": 123,
  "cliente": "Juan P√©rez",
  "servicio": "Internet 100MB",
  "total": 5000,
  "fecha_eliminacion": "2025-10-30 15:30:00"
}
```

### ‚ùå Log de Error

```log
[2025-10-30 15:30:00] local.ERROR: Error al eliminar servicio impago
{
  "usuario_id": 1,
  "servicio_pagar_id": 123,
  "error": "Only variables should be passed by reference",
  "trace": "..."
}
```

---

## üé® Interfaz de Usuario

### Vista para Usuario Normal (role_id = 1)
```
Pagar | Enviar Notif.
```
‚ùå **No ve** el bot√≥n "Eliminar"

### Vista para Admin/Super (role_id = 2 o 3)
```
Pagar | Enviar Notif. | Eliminar
```
‚úÖ **Ve** el bot√≥n "Eliminar" en color rojo

---

## üîê Seguridad Implementada

### 1. **Protecci√≥n de Permisos**
- Validaci√≥n en el servidor (Controller)
- Validaci√≥n en el cliente (Vista - solo muestra bot√≥n)

### 2. **Protecci√≥n CSRF**
```blade
@csrf
@method('DELETE')
```

### 3. **Confirmaci√≥n de Usuario**
- Alert JavaScript antes de enviar
- Muestra informaci√≥n del servicio

### 4. **Auditor√≠a**
- Log completo de qui√©n elimin√≥ qu√© y cu√°ndo
- Incluye informaci√≥n del servicio eliminado

---

## üß™ Casos de Prueba

### ‚úÖ Caso 1: Admin elimina servicio impago
**Resultado esperado:** Servicio eliminado exitosamente

### ‚ùå Caso 2: Usuario normal intenta eliminar
**Resultado esperado:** No ve el bot√≥n, si accede directo ‚Üí Error de permisos

### ‚ùå Caso 3: Admin intenta eliminar servicio pago
**Resultado esperado:** Error "Solo se pueden eliminar servicios en estado IMPAGO"

### ‚ùå Caso 4: Admin intenta eliminar servicio de otra empresa
**Resultado esperado:** Error "No puedes eliminar servicios de otra empresa"

### ‚ùå Caso 5: Servicio no existe
**Resultado esperado:** Error "El servicio no existe"

---

## üíª C√≥digo de la Vista

### Bot√≥n Eliminar (Solo visible para Admin/Super)

```blade
@if(Auth::user()->role_id == 2 || Auth::user()->role_id == 3)
  | 
  <strong>
    <a href="#" 
       onclick="event.preventDefault(); 
                if(confirm('¬øEst√° seguro que desea eliminar este servicio impago?\n\n
                           Cliente: {{$e->nombreCliente}}\n
                           Servicio: {{$e->nombreServicio}}\n
                           Total: ${{$e->total}}\n\n
                           Esta acci√≥n no se puede deshacer.')) { 
                  document.getElementById('delete-form-{{$e->idServicioPagar}}').submit(); 
                }" 
       data-tooltip="Eliminar (Solo Admin/Super)"
       style="color: #d32f2f;">
      Eliminar
    </a>
  </strong>
  <form id="delete-form-{{$e->idServicioPagar}}" 
        action="{{route('EliminarServicioImpago', ['idServicioPagar' => $e->idServicioPagar])}}" 
        method="POST" 
        style="display: none;">
    @csrf
    @method('DELETE')
  </form>
@endif
```

---

## üìù C√≥digo del Controller

```php
public function EliminarServicioImpago($idServicioPagar)
{
    try {
        $usuario = Auth::user();

        // Validaci√≥n 1: Permisos
        if (!in_array($usuario->role_id, [2, 3])) {
            return redirect()->back()
                ->withErrors(['No tienes permisos...']);
        }

        // Validaci√≥n 2: Existencia
        $servicioPagar = ServicioPagar::find($idServicioPagar);
        if (!$servicioPagar) {
            return redirect()->back()
                ->withErrors(['El servicio no existe.']);
        }

        // Validaci√≥n 3: Empresa
        $servicio = Servicio::find($servicioPagar->servicio_id);
        if ($servicio->empresa_id != $usuario->empresa_id) {
            return redirect()->back()
                ->withErrors(['No puedes eliminar servicios de otra empresa.']);
        }

        // Validaci√≥n 4: Estado
        if ($servicioPagar->estado !== 'impago') {
            return redirect()->back()
                ->withErrors(['Solo se pueden eliminar servicios en estado IMPAGO...']);
        }

        // Obtener info para log
        $cliente = $servicioPagar->cliente;
        $servicioNombre = $servicio->nombre;
        $total = $servicioPagar->total;

        // Eliminar
        $servicioPagar->delete();

        // Log
        \Log::info('Servicio impago eliminado', [...]);

        return redirect()->route('ServiciosImpagos')
            ->with('status', 'Servicio eliminado correctamente.');

    } catch (\Exception $e) {
        \Log::error('Error al eliminar servicio impago', [...]);
        return redirect()->back()
            ->withErrors(['Error al eliminar el servicio: ' . $e->getMessage()]);
    }
}
```

---

## ‚ö†Ô∏è Consideraciones Importantes

### 1. **No se puede deshacer**
- La eliminaci√≥n es **permanente**
- No hay papelera de reciclaje
- Se recomienda **confirmar bien** antes de eliminar

### 2. **Solo servicios impagos**
- Servicios **pagados** NO se pueden eliminar
- Esto protege la integridad de los registros contables

### 3. **Solo tu empresa**
- No puedes eliminar servicios de otras empresas
- Protecci√≥n adicional en entornos multi-empresa

### 4. **Logs permanentes**
- Aunque el servicio se elimine, queda registro en logs
- √ötil para auditor√≠a y seguimiento

---

## üöÄ Uso

### Como Usuario Admin o Super:

1. Ve a **Servicios Impagos**
2. Encuentra el servicio que deseas eliminar
3. Haz clic en **"Eliminar"** (bot√≥n rojo)
4. Confirma la eliminaci√≥n en el alert
5. El servicio se elimina y ves mensaje de confirmaci√≥n

### Como Usuario Normal:

- No ver√°s el bot√≥n "Eliminar"
- Si intentas acceder directo a la URL, recibir√°s error de permisos

---

## üìä Respuestas del Sistema

### ‚úÖ √âxito
```
Servicio eliminado correctamente.
```

### ‚ùå Errores Posibles

```
No tienes permisos para eliminar servicios. 
Solo usuarios Admin o Super pueden hacerlo.
```

```
El servicio no existe.
```

```
No puedes eliminar servicios de otra empresa.
```

```
Solo se pueden eliminar servicios en estado IMPAGO. 
Este servicio est√°: PAGO
```

```
Error al eliminar el servicio: [mensaje de error t√©cnico]
```

---

## üéâ Resultado Final

### Antes:
- No hab√≠a forma de eliminar servicios impagos
- Servicios mal registrados quedaban permanentemente

### Ahora:
- ‚úÖ Admin/Super pueden eliminar servicios impagos
- ‚úÖ 4 validaciones de seguridad
- ‚úÖ Logs de auditor√≠a
- ‚úÖ Confirmaci√≥n antes de eliminar
- ‚úÖ Solo servicios impagos
- ‚úÖ Solo de la propia empresa

---

**Desarrollado para:** LL Servicios  
**Fecha:** Octubre 2025  
**Versi√≥n:** 1.0.0  
**Permisos requeridos:** Admin (role_id = 2) o Super (role_id = 3)
