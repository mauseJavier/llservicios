# üì± Notificaci√≥n Mensual con WhatsApp

## üîÑ Integraci√≥n Completada

Se ha mejorado el comando `NotificacionMensual` para enviar notificaciones tanto por **Email** como por **WhatsApp** a los clientes con servicios impagos.

---

## ‚ú® Mejoras Implementadas

### 1. **Env√≠o Dual: Email + WhatsApp**
- ‚úÖ Mantiene el env√≠o de emails existente
- ‚úÖ Agrega env√≠o de WhatsApp autom√°tico
- ‚úÖ Solo env√≠a WhatsApp si el cliente tiene tel√©fono registrado

### 2. **Env√≠o As√≠ncrono con Jobs**
- ‚úÖ Los WhatsApp se env√≠an en segundo plano (no bloquean el proceso)
- ‚úÖ Reintentos autom√°ticos (3 intentos si falla)
- ‚úÖ Espaciado entre env√≠os para evitar saturaci√≥n

### 3. **Mensajes Mejorados**
- ‚úÖ Formato profesional con emojis
- ‚úÖ Detalle completo de cada servicio impago
- ‚úÖ Total adeudado destacado
- ‚úÖ Fecha de cada servicio

### 4. **Mejor Logging y Reportes**
- ‚úÖ Resumen en consola con estad√≠sticas
- ‚úÖ Log mejorado con informaci√≥n estructurada
- ‚úÖ Contador de emails y WhatsApps enviados
- ‚úÖ Registro de errores

### 5. **Interfaz de Consola Mejorada**
- ‚úÖ Informaci√≥n visual con emojis
- ‚úÖ Progreso en tiempo real
- ‚úÖ Colores para √©xitos, errores y advertencias

---

## üìã Uso del Comando

### Ejecutar Manualmente

```bash
php artisan app:notificacion-mensual
```

### Salida de Ejemplo

```
üîÑ Iniciando notificaci√≥n mensual de servicios impagos...
üìä Se encontraron 5 clientes con servicios impagos
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üì§ Procesando cliente: Juan P√©rez
  ‚úÖ Email enviado a: juan@email.com
  ‚úÖ WhatsApp programado para: 5492942506803
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üì§ Procesando cliente: Mar√≠a Garc√≠a
  ‚úÖ Email enviado a: maria@email.com
  ‚ö†Ô∏è  Cliente sin tel√©fono registrado
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìä RESUMEN DE NOTIFICACIONES
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  üìß Emails enviados: 5
  üì± WhatsApps programados: 4
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìù Log guardado en: storage/app/logs/NotificacionMailMensual.txt
‚úÖ Proceso completado exitosamente
```

---

## üì± Formato del Mensaje WhatsApp

Los clientes recibir√°n un mensaje como este:

```
‚ö†Ô∏è *RECORDATORIO DE SERVICIOS IMPAGOS*

Hola *Juan P√©rez*,

Te recordamos que tienes *3* servicio(s) pendiente(s) de pago:

üìã *Internet 50MB*
   ‚Ä¢ Cantidad: 1
   ‚Ä¢ Precio unitario: $5000
   ‚Ä¢ Total: $5000.00
   ‚Ä¢ Fecha: 15/09/2025

üìã *Telefon√≠a B√°sica*
   ‚Ä¢ Cantidad: 2
   ‚Ä¢ Precio unitario: $2500
   ‚Ä¢ Total: $5000.00
   ‚Ä¢ Fecha: 20/09/2025

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
*TOTAL ADEUDADO: $10000.00*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Por favor, regulariza tu situaci√≥n a la brevedad.

Cualquier consulta, no dudes en contactarnos.

_Mensaje autom√°tico - LLServicios_
```

---

## ‚öôÔ∏è Configuraci√≥n Autom√°tica (Cron)

### Agregar al Scheduler de Laravel

En `app/Console/Kernel.php`, agrega:

```php
protected function schedule(Schedule $schedule)
{
    // Enviar notificaci√≥n mensual el d√≠a 1 de cada mes a las 9:00 AM
    $schedule->command('app:notificacion-mensual')
             ->monthlyOn(1, '09:00')
             ->timezone('America/Argentina/Buenos_Aires');
    
    // O si prefieres el primer d√≠a h√°bil del mes
    $schedule->command('app:notificacion-mensual')
             ->monthlyOn(1, '09:00')
             ->when(function () {
                 return now()->isWeekday();
             });
}
```

### Opciones de Programaci√≥n

```php
// Cada primer d√≠a del mes a las 9:00
->monthlyOn(1, '09:00')

// Cada d√≠a 5 del mes a las 10:00
->monthlyOn(5, '10:00')

// El primer lunes de cada mes
->monthlyOn(1, '09:00')->mondays()

// Todos los d√≠as a las 9:00 (para testing)
->dailyAt('09:00')
```

### Activar el Scheduler

Agrega esta l√≠nea al crontab del servidor:

```bash
crontab -e
```

```
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

---

## üîß Requisitos Previos

### 1. Queue Worker Activo

Para que los WhatsApps se env√≠en, necesitas tener el queue worker corriendo:

```bash
# En producci√≥n (con supervisor)
php artisan queue:work --daemon

# En desarrollo
php artisan queue:work
```

### 2. Variables de Entorno Configuradas

Aseg√∫rate de tener en tu `.env`:

```env
WHATSAPP_API_URL=https://tu-api-whatsapp.com/api
WHATSAPP_API_KEY=tu_api_key
WHATSAPP_INSTANCE_ID=tu_instance_id
```

### 3. Clientes con Tel√©fono

Verifica que los clientes tengan el campo `telefono` lleno:

```sql
-- Ver clientes sin tel√©fono
SELECT id, nombre, correo FROM clientes WHERE telefono IS NULL OR telefono = '';

-- Actualizar tel√©fono de un cliente
UPDATE clientes SET telefono = '5492942506803' WHERE id = 1;
```

---

## üìä Monitoreo

### Ver Logs en Tiempo Real

```bash
# Log de Laravel (incluye WhatsApp y errores)
tail -f storage/logs/laravel.log

# Log espec√≠fico de notificaciones mensuales
tail -f storage/app/logs/NotificacionMailMensual.txt

# Filtrar solo WhatsApp
tail -f storage/logs/laravel.log | grep WhatsApp
```

### Ver Jobs en la Cola

```bash
# Ver trabajos pendientes
php artisan queue:listen --timeout=60

# Ver estad√≠sticas de la cola
php artisan queue:work --once

# Ver trabajos fallidos
php artisan queue:failed
```

---

## üß™ Testing

### Test Manual Paso a Paso

```bash
# 1. Ejecutar el comando
php artisan app:notificacion-mensual

# 2. Verificar que se crearon los Jobs
php artisan queue:work --once

# 3. Revisar logs
tail -50 storage/logs/laravel.log

# 4. Verificar archivo de log
cat storage/app/logs/NotificacionMailMensual.txt
```

### Test con Cliente Espec√≠fico

Puedes modificar temporalmente la consulta para probar con un cliente espec√≠fico:

```php
// En NotificacionMensual.php, l√≠nea ~35
$clientes = DB::select('SELECT ... WHERE a.cliente_id = b.id AND a.estado = ? AND b.id = ?', 
    ['impago', 1]); // Probar solo con cliente ID 1
```

---

## üîç Estructura del C√≥digo

### Flujo de Ejecuci√≥n

```
NotificacionMensual::handle()
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ 1. Obtener clientes con servicios impagos (SQL)
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ 2. Para cada cliente:
    ‚îÇ       ‚îú‚îÄ‚ñ∫ Obtener detalle de servicios impagos
    ‚îÇ       ‚îî‚îÄ‚ñ∫ Calcular total adeudado
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ 3. Para cada cliente:
    ‚îÇ       ‚îú‚îÄ‚ñ∫ Enviar Email (sincr√≥nico)
    ‚îÇ       ‚îî‚îÄ‚ñ∫ Programar WhatsApp (Job as√≠ncrono)
    ‚îÇ
    ‚îú‚îÄ‚ñ∫ 4. Mostrar resumen en consola
    ‚îÇ
    ‚îî‚îÄ‚ñ∫ 5. Guardar log del proceso
```

### M√©todos Implementados

| M√©todo | Descripci√≥n |
|--------|-------------|
| `handle()` | M√©todo principal que ejecuta todo el proceso |
| `generarMensajeWhatsApp($datos)` | Formatea el mensaje con los servicios impagos |
| `guardarLog($datos, ...)` | Guarda el log mejorado del proceso |

---

## üí° Casos de Uso

### 1. Notificaci√≥n Mensual Autom√°tica
```bash
# Configurar en cron para el d√≠a 1 de cada mes
* * 1 * * cd /path && php artisan app:notificacion-mensual
```

### 2. Notificaci√≥n Manual (Emergencia)
```bash
# Ejecutar cuando sea necesario
php artisan app:notificacion-mensual
```

### 3. Testing en Desarrollo
```bash
# Ver qu√© pasar√≠a sin enviar realmente
php artisan app:notificacion-mensual --dry-run  # (requiere implementar flag)
```

---

## üêõ Resoluci√≥n de Problemas

### Problema: Los WhatsApps no se env√≠an

**Soluciones:**
1. Verificar que el queue worker est√© corriendo:
   ```bash
   ps aux | grep "queue:work"
   ```

2. Ejecutar manualmente el worker:
   ```bash
   php artisan queue:work
   ```

3. Ver jobs fallidos:
   ```bash
   php artisan queue:failed
   php artisan queue:retry all
   ```

### Problema: Clientes no reciben mensajes

**Soluciones:**
1. Verificar formato de tel√©fono:
   ```sql
   SELECT telefono FROM clientes WHERE telefono IS NOT NULL;
   ```

2. Validar configuraci√≥n de WhatsApp:
   ```bash
   php artisan tinker
   >>> (new App\Services\WhatsAppService())->validateConfiguration()
   ```

3. Revisar logs de errores:
   ```bash
   tail -100 storage/logs/laravel.log | grep ERROR
   ```

### Problema: Emails se env√≠an pero WhatsApps no

**Causa:** Probablemente el queue worker no est√° corriendo o fall√≥.

**Soluci√≥n:**
```bash
# Reiniciar queue worker
php artisan queue:restart

# Ver trabajos en la cola
php artisan queue:listen
```

---

## üìà Mejoras Futuras Sugeridas

- [ ] Agregar flag `--dry-run` para simular sin enviar
- [ ] Agregar opci√≥n `--cliente-id` para probar con un cliente espec√≠fico
- [ ] Implementar l√≠mite de env√≠os por ejecuci√≥n
- [ ] Agregar estad√≠sticas a base de datos
- [ ] Crear dashboard de notificaciones enviadas
- [ ] Agregar plantillas personalizables de mensajes
- [ ] Implementar respuestas autom√°ticas de WhatsApp

---

## ‚úÖ Checklist de Implementaci√≥n

```
‚úÖ Servicio WhatsApp creado e integrado
‚úÖ Job de env√≠o as√≠ncrono implementado
‚úÖ Comando NotificacionMensual actualizado
‚úÖ Mensajes formateados profesionalmente
‚úÖ Logging y reportes mejorados
‚úÖ Documentaci√≥n completa creada
‚ñ° Configurar variables de entorno en producci√≥n
‚ñ° Activar queue worker en servidor
‚ñ° Configurar cron para ejecuci√≥n autom√°tica
‚ñ° Probar con clientes reales
‚ñ° Monitorear logs por 1 semana
```

---

## üìû Ejemplo de Uso Completo

```bash
# 1. Configurar entorno
echo "WHATSAPP_API_URL=..." >> .env
echo "WHATSAPP_INSTANCE_ID=..." >> .env

# 2. Iniciar queue worker (en otra terminal)
php artisan queue:work

# 3. Ejecutar notificaci√≥n
php artisan app:notificacion-mensual

# 4. Monitorear
tail -f storage/logs/laravel.log
```

---

**¬°La notificaci√≥n mensual ahora incluye WhatsApp autom√°tico! üéâ**
